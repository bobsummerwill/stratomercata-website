{%- comment -%}
Auto-link system that creates links for videos, articles, and people names
while avoiding double-linking (replacing text that's already inside links)

This system processes content in four phases:
0. Hidden People Links - Converts explicit links to hidden people into [REDACTED]
1. Videos - Links video titles to their pages
2. Articles - Links article titles to their pages (including embedded content)
3. People - Links person names to their pages, with conflict detection

The people processing phase includes conflict detection to prevent double-linking.
When a person's name appears within an article title that has already been linked,
the person name linking is skipped. For example:
- Article "Taylor Gerring Photos" gets linked first
- When processing people, "Taylor Gerring" is detected as already being
  part of an existing article link, so it's skipped
- This prevents creating nested <a> tags like:
  <a href="/articles/taylor-gerring-photos/"><a href="/people/taylor-gerring/">Taylor Gerring</a> Photos</a>

The system maintains proper priority: Hidden People > Videos > Articles > People
while ensuring clean, valid HTML output.
{%- endcomment -%}

{%- assign body_content = include.content -%}

{%- comment -%}Protect content inside no-auto-link-marker spans{%- endcomment -%}
{%- assign protected_spans = "" | split: "" -%}
{%- assign span_parts = body_content | split: '<span class="no-auto-link-marker">' -%}
{%- if span_parts.size > 1 -%}
  {%- assign new_body = span_parts[0] -%}
  {%- for part in span_parts offset: 1 -%}
    {%- assign end_parts = part | split: '</span>' -%}
    {%- if end_parts.size > 1 -%}
      {%- assign placeholder = '___PROTECTED_SPAN_' | append: forloop.index | append: '___' -%}
      {%- assign original_content = '<span class="no-auto-link-marker">' | append: end_parts[0] | append: '</span>' -%}
      {%- assign span_pair = placeholder | append: '|||' | append: original_content -%}
      {%- assign protected_spans = protected_spans | push: span_pair -%}
      {%- assign new_body = new_body | append: placeholder -%}
      {%- for remaining in end_parts offset: 1 -%}
        {%- if forloop.first -%}
          {%- assign new_body = new_body | append: remaining -%}
        {%- else -%}
          {%- assign new_body = new_body | append: '</span>' | append: remaining -%}
        {%- endif -%}
      {%- endfor -%}
    {%- else -%}
      {%- assign new_body = new_body | append: '<span class="no-auto-link-marker">' | append: part -%}
    {%- endif -%}
  {%- endfor -%}
  {%- assign body_content = new_body -%}
{%- endif -%}

{%- comment -%}Process hidden people links first - replace explicit links to hidden people with [REDACTED]{%- endcomment -%}
{%- for person in site.people -%}
  {%- if person.hidden -%}
    {%- comment -%}Handle links with various formats - we need to replace the entire <a>...</a> tag{%- endcomment -%}
    {%- assign person_url_pattern = person.url | append: '"' -%}
    {%- assign person_url_pattern_slash = person.url | append: '/"' -%}
    
    {%- comment -%}Split content on opening link tag to find matches{%- endcomment -%}
    {%- assign parts = body_content | split: '<a href="' -%}
    {%- assign new_content = "" -%}
    {%- for part in parts -%}
      {%- if forloop.first -%}
        {%- assign new_content = part -%}
      {%- else -%}
        {%- comment -%}Check if this part starts with the hidden person's URL{%- endcomment -%}
        {%- if part contains person_url_pattern or part contains person_url_pattern_slash -%}
          {%- comment -%}Find the closing tag and replace the link with [REDACTED]{%- endcomment -%}
          {%- assign close_tag_parts = part | split: '</a>' -%}
          {%- if close_tag_parts.size > 1 -%}
            {%- comment -%}Check if this is actually a link to this person{%- endcomment -%}
            {%- assign link_start = close_tag_parts[0] -%}
            {%- if link_start contains person.url -%}
              {%- assign new_content = new_content | append: '[REDACTED]' -%}
              {%- for remaining_part in close_tag_parts offset: 1 -%}
                {%- if forloop.first -%}
                  {%- assign new_content = new_content | append: remaining_part -%}
                {%- else -%}
                  {%- assign new_content = new_content | append: '</a>' | append: remaining_part -%}
                {%- endif -%}
              {%- endfor -%}
            {%- else -%}
              {%- assign new_content = new_content | append: '<a href="' | append: part -%}
            {%- endif -%}
          {%- else -%}
            {%- assign new_content = new_content | append: '<a href="' | append: part -%}
          {%- endif -%}
        {%- else -%}
          {%- assign new_content = new_content | append: '<a href="' | append: part -%}
        {%- endif -%}
      {%- endif -%}
    {%- endfor -%}
    {%- assign body_content = new_content -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%}Process videos first{%- endcomment -%}
{%- for video in site.videos -%}
  {%- assign title_to_replace = video.title -%}
  {%- assign link_replacement = '<a href="' | append: video.url | append: '">' | append: video.title | append: '</a>' -%}
  {%- assign body_content = body_content | replace: title_to_replace, link_replacement -%}
{%- endfor -%}

{%- comment -%}Protect rendered content-embed blocks (blog-embed-card divs) from auto-linking{%- endcomment -%}
{%- assign content_embeds = "" | split: "" -%}
{%- assign embed_parts = body_content | split: '<div class="blog-embed-card"' -%}
{%- if embed_parts.size > 1 -%}
  {%- assign new_body = embed_parts[0] -%}
  {%- for part in embed_parts offset: 1 -%}
    {%- assign end_parts = part | split: '</div>' -%}
    {%- if end_parts.size > 1 -%}
      {%- comment -%}Find the closing div for blog-embed-card by counting nested divs{%- endcomment -%}
      {%- assign div_count = 1 -%}
      {%- assign embed_content = '<div class="blog-embed-card"' | append: end_parts[0] -%}
      {%- assign remaining_content = "" -%}
      {%- for remaining_part in end_parts offset: 1 -%}
        {%- assign div_opens = remaining_part | split: '<div' | size | minus: 1 -%}
        {%- assign div_count = div_count | plus: div_opens | minus: 1 -%}
        {%- if div_count == 0 -%}
          {%- assign embed_content = embed_content | append: '</div>' -%}
          {%- assign remaining_content = remaining_part -%}
          {%- for rest in end_parts offset: forloop.index | plus: 1 -%}
            {%- assign remaining_content = remaining_content | append: '</div>' | append: rest -%}
          {%- endfor -%}
          {%- break -%}
        {%- else -%}
          {%- assign embed_content = embed_content | append: '</div>' | append: remaining_part -%}
        {%- endif -%}
      {%- endfor -%}
      {%- assign placeholder = '___CONTENT_EMBED_' | append: forloop.index | append: '___' -%}
      {%- assign embed_pair = placeholder | append: '|||' | append: embed_content -%}
      {%- assign content_embeds = content_embeds | push: embed_pair -%}
      {%- assign new_body = new_body | append: placeholder | append: remaining_content -%}
    {%- else -%}
      {%- assign new_body = new_body | append: '<div class="blog-embed-card"' | append: part -%}
    {%- endif -%}
  {%- endfor -%}
  {%- assign body_content = new_body -%}
{%- endif -%}

{%- comment -%}Process articles second - always create simple links, never embeds{%- endcomment -%}
{%- for article in site.articles -%}
  {%- assign title_to_replace = article.title -%}
  {%- assign alias_to_replace = article.alias -%}
  {%- assign link_replacement = '<a href="' | append: article.url | append: '">' | append: article.title | append: '</a>' -%}
  {%- assign body_content = body_content | replace: title_to_replace, link_replacement -%}
  {%- if alias_to_replace %}
    {%- assign alias_link_replacement = '<a href="' | append: article.url | append: '">' | append: article.alias | append: '</a>' -%}
    {%- assign body_content = body_content | replace: alias_to_replace, alias_link_replacement -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%}Process people last, protecting instances that are part of existing links{%- endcomment -%}
{%- for other_person in site.people -%}
  {%- assign name_to_replace = other_person.name -%}
  {%- assign display_name = other_person.name -%}
  
  {%- comment -%}Create the replacement link{%- endcomment -%}
  {%- if other_person.hidden -%}
    {%- assign link_replacement = '<span class="hidden-autolink" data-original-name="' | append: display_name | append: '" data-original-url="' | append: other_person.url | append: '">[REDACTED]</span>' -%}
  {%- else -%}
    {%- assign link_replacement = '<a href="' | append: other_person.url | append: '">' | append: other_person.name | append: '</a>' -%}
  {%- endif -%}
  
  {%- comment -%}Replace person names, but protect instances within existing article/video links{%- endcomment -%}
  {%- assign temp_content = body_content -%}
  
  {%- comment -%}First, temporarily replace article and video links that contain this person's name{%- endcomment -%}
  {%- assign protected_links = "" | split: "" -%}
  {%- assign link_counter = 0 -%}
  
  {%- for article in site.articles -%}
    {%- if article.title contains name_to_replace -%}
      {%- assign article_link_pattern = '<a href="' | append: article.url | append: '">' | append: article.title | append: '</a>' -%}
      {%- if temp_content contains article_link_pattern -%}
        {%- assign placeholder = '___PROTECTED_LINK_' | append: link_counter | append: '___' -%}
        {%- assign temp_content = temp_content | replace_first: article_link_pattern, placeholder -%}
        {%- assign protected_pair = placeholder | append: '|||' | append: article_link_pattern -%}
        {%- assign protected_links = protected_links | push: protected_pair -%}
        {%- assign link_counter = link_counter | plus: 1 -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
  
  {%- for video in site.videos -%}
    {%- if video.title contains name_to_replace -%}
      {%- assign video_link_pattern = '<a href="' | append: video.url | append: '">' | append: video.title | append: '</a>' -%}
      {%- if temp_content contains video_link_pattern -%}
        {%- assign placeholder = '___PROTECTED_LINK_' | append: link_counter | append: '___' -%}
        {%- assign temp_content = temp_content | replace_first: video_link_pattern, placeholder -%}
        {%- assign protected_pair = placeholder | append: '|||' | append: video_link_pattern -%}
        {%- assign protected_links = protected_links | push: protected_pair -%}
        {%- assign link_counter = link_counter | plus: 1 -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
  
  {%- comment -%}Now replace the person name in the remaining content{%- endcomment -%}
  {%- assign temp_content = temp_content | replace: name_to_replace, link_replacement -%}
  
  {%- comment -%}Restore the protected links{%- endcomment -%}
  {%- for pair in protected_links -%}
    {%- assign parts = pair | split: '|||' -%}
    {%- assign placeholder = parts[0] -%}
    {%- assign original_link = parts[1] -%}
    {%- assign temp_content = temp_content | replace: placeholder, original_link -%}
  {%- endfor -%}
  
  {%- assign body_content = temp_content -%}
{%- endfor -%}

{%- comment -%}Restore content-embed includes{%- endcomment -%}
{%- for pair in content_embeds -%}
  {%- assign parts = pair | split: '|||' -%}
  {%- assign placeholder = parts[0] -%}
  {%- assign original_embed = parts[1] -%}
  {%- assign body_content = body_content | replace: placeholder, original_embed -%}
{%- endfor -%}

{%- comment -%}Restore protected span markers{%- endcomment -%}
{%- for pair in protected_spans -%}
  {%- assign parts = pair | split: '|||' -%}
  {%- assign placeholder = parts[0] -%}
  {%- assign original_content = parts[1] -%}
  {%- assign body_content = body_content | replace: placeholder, original_content -%}
{%- endfor -%}

{{ body_content }}
